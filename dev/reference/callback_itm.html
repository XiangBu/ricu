<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Item callback utilities — transform_fun • ICU data with R</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Item callback utilities — transform_fun" />
<meta property="og:description" content="For concept loading, item callback functions are used in order to handle
item-specific post-processing steps, such as converting measurement units,
mapping a set of values to another or for more involved data
transformations, like turning absolute drug administration rates into rates
that are relative to body weight. Item callback functions are called by
load_concepts() with arguments x (the data), a variable number of name/
string pairs specifying roles of columns for the given item, followed by
env, the data source environment as src_env object.
Item callback functions can be specified by their name or using function
factories such as transform_fun(), apply_map() or convert_unit()." />


<meta name="robots" content="noindex">

<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ICU data with R</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/jss.pdf">\pkg{ricu}: \proglang{R}'s interface for ICU data (PDF)</a>
    </li>
    <li>
      <a href="../articles/uom.html">Units of measurement</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/septic-tank/ricu">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Item callback utilities</h1>
    
    <div class="hidden name"><code>callback_itm.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>For concept loading, item callback functions are used in order to handle
item-specific post-processing steps, such as converting measurement units,
mapping a set of values to another or for more involved data
transformations, like turning absolute drug administration rates into rates
that are relative to body weight. Item callback functions are called by
<code><a href='load_concepts.html'>load_concepts()</a></code> with arguments <code>x</code> (the data), a variable number of name/
string pairs specifying roles of columns for the given item, followed by
<code>env</code>, the data source environment as <code><a href='data.html'>src_env</a></code> object.
Item callback functions can be specified by their name or using function
factories such as <code>transform_fun()</code>, <code>apply_map()</code> or <code>convert_unit()</code>.</p>
    </div>

    <pre class="usage"><span class='fu'>transform_fun</span>(<span class='kw'>fun</span>, <span class='kw'>...</span>)

<span class='fu'>binary_op</span>(<span class='kw'>op</span>, <span class='kw'>y</span>)

<span class='fu'>comp_na</span>(<span class='kw'>op</span>, <span class='kw'>y</span>)

<span class='fu'>apply_map</span>(<span class='kw'>map</span>)

<span class='fu'>convert_unit</span>(<span class='kw'>rgx</span>, <span class='kw'>fun</span>, <span class='kw'>new</span>, ignore_case = <span class='fl'>TRUE</span>, <span class='kw'>...</span>)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>fun</th>
      <td><p>Function(s) used for transforming matching values</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Further arguments passed to downstream function</p></td>
    </tr>
    <tr>
      <th>op</th>
      <td><p>Function taking two arguments, such as <code><a href='https://rdrr.io/r/base/Arithmetic.html'>+</a></code></p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>Value passed as second argument to function <code>op</code></p></td>
    </tr>
    <tr>
      <th>map</th>
      <td><p>Named atomic vector used for mapping a set of values (the names
of <code>map</code>) to a different set (the values of <code>map</code>)</p></td>
    </tr>
    <tr>
      <th>rgx</th>
      <td><p>Regular expression(s) used for identifying observations based on
their current unit of measurement</p></td>
    </tr>
    <tr>
      <th>new</th>
      <td><p>Name(s) of transformed units</p></td>
    </tr>
    <tr>
      <th>ignore_case</th>
      <td><p>Forwarded to <code><a href='https://rdrr.io/r/base/grep.html'>base::grep()</a></code></p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The most forward setting is where a function is simply referred to by its
name. For example in eICU, age is available as character vector due to
ages 90 and above being represented by the string "&gt; 89". A function such
as the following turns this into a numeric vector, replacing occurrences of
"&gt; 89" by the number 90.</p><pre><span class='kw'>eicu_age</span> <span class='op'>&lt;-</span> <span class='fu'>function</span>(<span class='kw'>x</span>, <span class='kw'>val_var</span>, <span class='kw'>...</span>) {
  <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/assign.html'>set</a></span>(
    <span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/assign.html'>set</a></span>(<span class='kw'>x</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span>(<span class='kw'>x</span>[[<span class='kw'>val_var</span>]] <span class='op'>==</span> <span class='st'>"&gt; 89"</span>), j = <span class='kw'>val_var</span>,
                    value = <span class='fl'>90</span>),
    j = <span class='kw'>val_var</span>,
    value = <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span>(<span class='kw'>x</span>[[<span class='kw'>val_var</span>]])
  )
}
</pre>

<p>This function then is specified as item callback function for items
corresponding to eICU data sources of the <code>age</code> concept as</p><pre><span class='fu'><a href='new_itm.html'>item</a></span>(src = <span class='st'>"eicu_demo"</span>, table = <span class='st'>"patient"</span>, val_var = <span class='st'>"age"</span>,
     callback = <span class='st'>"eicu_age"</span>, class = <span class='st'>"col_itm"</span>)
</pre>

<p>The string passed as <code>callback</code> argument is evaluated, meaning that an
expression can be passed which evaluates to a function that in turn can be
used as callback. Several function factories are provided which return
functions suitable for use as item callbacks: <code>transform_fun()</code> creates a
function that transforms the <code>val_var</code> column using the function supplied
as <code>fun</code> argument, <code>apply_map()</code> can be used to map one set of values to
another (again using the <code>val_var</code> column) and <code>convert_unit()</code> is intended
for converting a subset of rows (identified by matching <code>rgx</code> against the
<code>unit_var</code> column) by applying <code>fun</code> to the <code>val_var</code> column and setting
<code>new</code> as the transformed unit name (arguments are not limited to scalar
values). As transformations require unary functions, two utility function,
<code>binary_op()</code> and <code>comp_na()</code> are provided which can be used to fix the
second argument of binary functions such as <code><a href='https://rdrr.io/r/base/Arithmetic.html'>*</a></code> or <code><a href='https://rdrr.io/r/base/Comparison.html'>==</a></code>. Taking all this
together, an item callback function for dividing the <code>val_var</code> column by 2
could be specified as <code>"transform_fun(binary_op(</code>/<code>, 2))"</code>. The supplied
function factories create functions that operate on the data using
by-reference semantics. Furthermore, during concept
loading, progress is reported by a <a href='https://rdrr.io/pkg/progress/man/progress_bar.html'>progress::progress_bar</a>. In order to
signal a message without disrupting the current loading status, see
<code><a href='msg_progress.html'>msg_progress()</a></code>.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='id_tbl.html'>ts_tbl</a></span>(x = <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span>(<span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span>, each = <span class='fl'>5</span>), y = <span class='fu'><a href='secs.html'>hours</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span>(<span class='fl'>1</span><span class='op'>:</span><span class='fl'>5</span>, <span class='fl'>2</span>)), z = <span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>)
</div><div class='output co'>#&gt; <span class='message'>In order to automatically determine the index column, exactly one `difftime`</span>
#&gt; <span class='message'>column is required.</span></div><div class='input'>
<span class='kw'>subtract_3</span> <span class='op'>&lt;-</span> <span class='fu'>transform_fun</span>(<span class='fu'>binary_op</span>(<span class='kw'>`-`</span>, <span class='fl'>3</span>))
<span class='fu'>subtract_3</span>(<span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/copy.html'>copy</a></span>(<span class='kw'>dat</span>), val_var = <span class='st'>"z"</span>)
</div><div class='output co'>#&gt; <span style='color: #555555;'># A `ts_tbl`: 10 ✖ 3</span><span>
#&gt; </span><span style='color: #555555;'># Id var:     `x`</span><span>
#&gt; </span><span style='color: #555555;'># Index var:  `y` (1 hours)</span><span>
#&gt;        x y           z
#&gt;    </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;drtn&gt;</span><span>  </span><span style='color: #555555;font-style: italic;'>&lt;dbl&gt;</span><span>
#&gt; </span><span style='color: #555555;'>1</span><span>      1 1 hours    -</span><span style='color: #BB0000;'>2</span><span>
#&gt; </span><span style='color: #555555;'>2</span><span>      1 2 hours    -</span><span style='color: #BB0000;'>1</span><span>
#&gt; </span><span style='color: #555555;'>3</span><span>      1 3 hours     0
#&gt; </span><span style='color: #555555;'>4</span><span>      1 4 hours     1
#&gt; </span><span style='color: #555555;'>5</span><span>      1 5 hours     2
#&gt; </span><span style='color: #555555;'>6</span><span>      2 1 hours     3
#&gt; </span><span style='color: #555555;'>7</span><span>      2 2 hours     4
#&gt; </span><span style='color: #555555;'>8</span><span>      2 3 hours     5
#&gt; </span><span style='color: #555555;'>9</span><span>      2 4 hours     6
#&gt; </span><span style='color: #555555;'>10</span><span>     2 5 hours     7</div><div class='input'>
<span class='kw'>gte_4</span> <span class='op'>&lt;-</span> <span class='fu'>transform_fun</span>(<span class='fu'>comp_na</span>(<span class='kw'>`&gt;=`</span>, <span class='fl'>4</span>))
<span class='fu'>gte_4</span>(<span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/copy.html'>copy</a></span>(<span class='kw'>dat</span>), val_var = <span class='st'>"z"</span>)
</div><div class='output co'>#&gt; </span><span style='color: #555555;'># A `ts_tbl`: 10 ✖ 3</span><span>
#&gt; </span><span style='color: #555555;'># Id var:     `x`</span><span>
#&gt; </span><span style='color: #555555;'># Index var:  `y` (1 hours)</span><span>
#&gt;        x y       z    
#&gt;    </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;drtn&gt;</span><span>  </span><span style='color: #555555;font-style: italic;'>&lt;lgl&gt;</span><span>
#&gt; </span><span style='color: #555555;'>1</span><span>      1 1 hours FALSE
#&gt; </span><span style='color: #555555;'>2</span><span>      1 2 hours FALSE
#&gt; </span><span style='color: #555555;'>3</span><span>      1 3 hours FALSE
#&gt; </span><span style='color: #555555;'>4</span><span>      1 4 hours TRUE 
#&gt; </span><span style='color: #555555;'>5</span><span>      1 5 hours TRUE 
#&gt; </span><span style='color: #555555;'>6</span><span>      2 1 hours TRUE 
#&gt; </span><span style='color: #555555;'>7</span><span>      2 2 hours TRUE 
#&gt; </span><span style='color: #555555;'>8</span><span>      2 3 hours TRUE 
#&gt; </span><span style='color: #555555;'>9</span><span>      2 4 hours TRUE 
#&gt; </span><span style='color: #555555;'>10</span><span>     2 5 hours TRUE </div><div class='input'>
<span class='kw'>map_letters</span> <span class='op'>&lt;-</span> <span class='fu'>apply_map</span>(<span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span>(<span class='kw'>letters</span>[<span class='fl'>1</span><span class='op'>:</span><span class='fl'>9</span>], <span class='fl'>1</span><span class='op'>:</span><span class='fl'>9</span>))
<span class='kw'>res</span> <span class='op'>&lt;-</span> <span class='fu'>map_letters</span>(<span class='kw'>data.table</span>::<span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/copy.html'>copy</a></span>(<span class='kw'>dat</span>), val_var = <span class='st'>"z"</span>)
<span class='kw'>res</span>
</div><div class='output co'>#&gt; </span><span style='color: #555555;'># A `ts_tbl`: 10 ✖ 3</span><span>
#&gt; </span><span style='color: #555555;'># Id var:     `x`</span><span>
#&gt; </span><span style='color: #555555;'># Index var:  `y` (1 hours)</span><span>
#&gt;        x y       z    
#&gt;    </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;drtn&gt;</span><span>  </span><span style='color: #555555;font-style: italic;'>&lt;chr&gt;</span><span>
#&gt; </span><span style='color: #555555;'>1</span><span>      1 1 hours a    
#&gt; </span><span style='color: #555555;'>2</span><span>      1 2 hours b    
#&gt; </span><span style='color: #555555;'>3</span><span>      1 3 hours c    
#&gt; </span><span style='color: #555555;'>4</span><span>      1 4 hours d    
#&gt; </span><span style='color: #555555;'>5</span><span>      1 5 hours e    
#&gt; </span><span style='color: #555555;'>6</span><span>      2 1 hours f    
#&gt; </span><span style='color: #555555;'>7</span><span>      2 2 hours g    
#&gt; </span><span style='color: #555555;'>8</span><span>      2 3 hours h    
#&gt; </span><span style='color: #555555;'>9</span><span>      2 4 hours i    
#&gt; </span><span style='color: #555555;'>10</span><span>     2 5 hours </span><span style='color: #BB0000;'>NA</span><span>   </div><div class='input'>
<span class='kw'>not_b</span> <span class='op'>&lt;-</span> <span class='fu'>transform_fun</span>(<span class='fu'>comp_na</span>(<span class='kw'>`!=`</span>, <span class='st'>"b"</span>))
<span class='fu'>not_b</span>(<span class='kw'>res</span>, val_var = <span class='st'>"z"</span>)
</div><div class='output co'>#&gt; </span><span style='color: #555555;'># A `ts_tbl`: 10 ✖ 3</span><span>
#&gt; </span><span style='color: #555555;'># Id var:     `x`</span><span>
#&gt; </span><span style='color: #555555;'># Index var:  `y` (1 hours)</span><span>
#&gt;        x y       z    
#&gt;    </span><span style='color: #555555;font-style: italic;'>&lt;int&gt;</span><span> </span><span style='color: #555555;font-style: italic;'>&lt;drtn&gt;</span><span>  </span><span style='color: #555555;font-style: italic;'>&lt;lgl&gt;</span><span>
#&gt; </span><span style='color: #555555;'>1</span><span>      1 1 hours TRUE 
#&gt; </span><span style='color: #555555;'>2</span><span>      1 2 hours FALSE
#&gt; </span><span style='color: #555555;'>3</span><span>      1 3 hours TRUE 
#&gt; </span><span style='color: #555555;'>4</span><span>      1 4 hours TRUE 
#&gt; </span><span style='color: #555555;'>5</span><span>      1 5 hours TRUE 
#&gt; </span><span style='color: #555555;'>6</span><span>      2 1 hours TRUE 
#&gt; </span><span style='color: #555555;'>7</span><span>      2 2 hours TRUE 
#&gt; </span><span style='color: #555555;'>8</span><span>      2 3 hours TRUE 
#&gt; </span><span style='color: #555555;'>9</span><span>      2 4 hours TRUE 
#&gt; </span><span style='color: #555555;'>10</span><span>     2 5 hours FALSE</div><div class='input'>
</div></span></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Nicolas Bennett, Drago Plecko, Ida-Fong Ukor.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.0.9000.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


